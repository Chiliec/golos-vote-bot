<!doctype html>
<html lang="en">
<head>
    <title>Голосовалочка</title>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="https://golos.io/images/favicons/favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"
          integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
</head>
<body>
<div class="container">
    <h1>Голосовалочка</h1>
    <div class="alert alert-primary" role="alert">
        Эта страница позволяет добавить в свой аккаунт доверенность для управления постинг-возможностями аккаунту <a
            href="https://golos.io/@golosovalochka">Голосовалочки</a>, чтобы она могла своим ключом подписывать
        постинг-транзакции от вашего имени. Таким образом отпадает необходимость передачи и хранения приватных
        ключей.<br/> Отозвать доверенность можно изменением пароля или <a
            href="https://golos.cf/multi/off.html">здесь</a>.
    </div>
    <div class="alert alert-danger" role="alert">
        Прежде чем вводить свой приватный активный ключ, если есть такая возможность, покажите эту страницу техническим
        специалистам. Компрометация приватного активного ключа равнозначна потере токенов.
    </div>
    <form>
        <div class="input-group">
            <span class="input-group-addon" id="creatorDescribed">@</span>
            <input id="creator" type="text" class="form-control" placeholder="chiliec" aria-label="Username"
                   aria-describedby="creatorDescribed">
        </div>
        <div class="form-group">
            <label for="wif">Активный приватный ключ</label>
            <input id="wif" type="password" class="form-control" placeholder="5...">
            <small class="form-text text-muted">
                Найти свои ключи можно в разделе <strong>Кошелек -> Разрешения</strong>.
                Затем нажать кнопку "Показать активный ключ". Он должен начинаться с цифры 5.
            </small>
        </div>
        <button id="sendForm" type="button" class="btn btn-primary">Делегировать</button>
    </form>
    <br />
    <div id="out"></div>
</div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
        integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
        integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>
<script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
<script>
steem.config.set('websocket', 'wss://api.golos.cf');

steem.config.set('address_prefix', 'GLS');
steem.config.set('chain_id', '782a3039b478c839e4cb0c941ff4eaeb7df40bdd68bd441afd444b9da763de12');

var button = document.getElementById("sendForm");
button.addEventListener("click", function(event) {
    var recipient = "golosovalochka";
    var wif = document.getElementById("wif").value;
    var creator = document.getElementById("creator").value;
    if (wif == "" || creator == "") {
        document.getElementById('out').innerHTML = "<div class='alert alert-warning' role='alert'><h4>Не введены данные!</h4>";
        return;
    }
    button.disabled = true;
    steem.api.getAccounts([creator], function(err, data) {
        if (err) {
            console.warn(err);
            button.disabled = false;
            return;
        }
        if (data.length === 0) {
            document.getElementById('out').innerHTML = "<div class='alert alert-warning' role='alert'><h4>Некорректный логин или приватный активный ключ!</h4>";
            button.disabled = false;
            return;
        }
        var account = data[0];
        var pAuth = account.posting;
        for (i = 0; i < pAuth.account_auths.length; i++) {
            if (pAuth.account_auths[i][0] == recipient) {
                document.getElementById('out').innerHTML = "<div class='alert alert-primary' role='alert'><h4>Доступ уже делегирован!</h4>Закрой окно и введи свой логин в Голосовалочке"
                return;
            }
        }
        var memo = account.memo_key;
        pAuth.account_auths.push([recipient, pAuth.weight_threshold]);
        steem.broadcast.accountUpdate(wif, creator, undefined, undefined, pAuth, memo, account.json_metadata, function(err, result) {
            console.log(err, result);
            if (err) {
                return document.getElementById('out').innerHTML = "<div class='alert alert-danger' role='alert'><h4>Ошибка!</h4>Подробности ошибки в консоли браузера</div>"
                button.disabled = false;
            } else {
                document.getElementById('out').innerHTML = "<div class='alert alert-primary' role='alert'><h4>Успех!</h4>Закрой окно и введи свой логин в Голосовалочке"
            }
        });
    });
});
</script>
</body>
</html>
